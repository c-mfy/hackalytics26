<!-- 
    main HTML page 
    includes dashboard chars/tables/display
    loads JS and CSS
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>speechwrite — speech right with speech write</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Italiana&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --sky: #03060f;
      --accent: #4af0c4;
      --accent3: #ffd166;
      --text: #c8d8e8;
      --dim: rgba(200,216,232,0.32);
      --mono: 'DM Mono', monospace;
      --display: 'Bebas Neue', cursive;
      --serif: 'Italiana', serif;
    }

    html, body {
      width: 100%; height: 100%;
      overflow: hidden;
      background: var(--sky);
      color: var(--text);
      font-family: var(--mono);
      cursor: default;
    }

    /* ── STARFIELD ─────────────────────────────────────── */
    #starfield {
      position: fixed;
      inset: 0;
      z-index: 0;
    }

    /* ── GHOST BRAND TEXT (sits behind globe visually) ── */
    #brand-layer {
      position: fixed;
      inset: 0;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      user-select: none;
    }

    .brand-name {
      font-family: var(--display);
      font-size: clamp(72px, 14vw, 210px);
      letter-spacing: 0.03em;
      color: transparent;
      -webkit-text-stroke: 1px rgba(74,240,196,0.09);
      line-height: 0.86;
      white-space: nowrap;
      animation: breathe 8s ease-in-out infinite;
    }

    .brand-slogan {
      font-family: var(--serif);
      font-size: clamp(10px, 1.1vw, 17px);
      letter-spacing: 0.3em;
      color: rgba(74,240,196,0.11);
      margin-top: 12px;
      text-transform: lowercase;
      font-style: italic;
      animation: breathe 8s ease-in-out infinite 2s;
    }

    @keyframes breathe {
      0%,100% { opacity: 0.5; }
      50%      { opacity: 1; }
    }

    /* ── DECORATIVE ORBIT RING ─────────────────────────── */
    .orbit-ring {
      position: fixed;
      inset: 0;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .orbit-svg {
      width: min(80vw, 80vh);
      height: min(80vw, 80vh);
      animation: spin 28s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── GLOBE CONTAINER ───────────────────────────────── */
    #globe-wrapper {
      position: fixed;
      inset: 0;
      z-index: 2;
    }

    /* ── HOVER TOOLTIP ─────────────────────────────────── */
    #tip {
      position: fixed;
      z-index: 30;
      display: none;
      pointer-events: none;
      min-width: 200px;
    }

    .tip-inner {
      background: rgba(3, 8, 18, 0.95);
      border: 1px solid rgba(74,240,196,0.2);
      border-radius: 5px;
      padding: 15px 19px;
      backdrop-filter: blur(16px);
      box-shadow: 0 8px 50px rgba(0,0,0,0.75), 0 0 20px rgba(74,240,196,0.06);
    }

    .tip-country {
      font-family: var(--display);
      font-size: 21px;
      letter-spacing: 0.05em;
      color: #fff;
      margin-bottom: 3px;
    }

    .tip-accent {
      font-size: 9px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--dim);
      margin-bottom: 12px;
    }

    .tip-wer {
      font-family: var(--display);
      font-size: 34px;
      line-height: 1;
      margin-bottom: 2px;
    }

    .tip-wer-label {
      font-size: 9px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--dim);
      margin-bottom: 9px;
    }

    .tip-bar { width: 100%; height: 3px; background: rgba(255,255,255,0.07); border-radius: 2px; }
    .tip-fill { height: 100%; border-radius: 2px; transition: width .3s; }

    .tip-badge {
      display: inline-block;
      margin-top: 9px;
      padding: 3px 8px;
      border-radius: 2px;
      font-size: 9px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    /* ── TOP NAV ───────────────────────────────────────── */
    #ui {
      position: fixed;
      inset: 0;
      z-index: 10;
      pointer-events: none;
    }

    .nav {
      position: absolute;
      top: 0; left: 0; right: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 32px;
      pointer-events: all;
    }

    .logo-wrap { line-height: 1; }

    .logo-name {
      font-family: var(--display);
      font-size: 24px;
      letter-spacing: 0.04em;
      color: var(--accent);
      text-shadow: 0 0 24px rgba(74,240,196,0.42);
      text-transform: lowercase;
    }

    .logo-slogan {
      font-family: var(--mono);
      font-size: 8.5px;
      letter-spacing: 0.16em;
      color: var(--dim);
      margin-top: 1px;
      font-style: italic;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .nav-link {
      font-size: 9.5px;
      letter-spacing: 0.16em;
      color: var(--dim);
      text-decoration: none;
      text-transform: lowercase;
      cursor: pointer;
      transition: color .2s;
    }

    .nav-link:hover { color: var(--accent); }

    .upload-btn {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 9px 20px;
      background: transparent;
      border: 1px solid rgba(74,240,196,0.35);
      border-radius: 2px;
      color: var(--accent);
      font-family: var(--mono);
      font-size: 9.5px;
      letter-spacing: 0.16em;
      text-transform: lowercase;
      cursor: pointer;
      transition: all .22s;
      position: relative;
      overflow: hidden;
    }

    .upload-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--accent);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform .22s ease;
      z-index: -1;
    }

    .upload-btn:hover {
      color: #03060f;
      border-color: var(--accent);
      box-shadow: 0 0 24px rgba(74,240,196,0.25);
    }

    .upload-btn:hover::after { transform: scaleX(1); }
    .upload-btn svg { width: 12px; height: 12px; fill: currentColor; }

    /* ── ZOOM CONTROLS ─────────────────────────────────── */
    .zoom-controls {
      position: absolute;
      right: 32px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 6px;
      pointer-events: all;
    }

    .zoom-btn {
      width: 32px; height: 32px;
      background: rgba(3,8,18,0.8);
      border: 1px solid rgba(74,240,196,0.2);
      border-radius: 3px;
      color: var(--dim);
      font-size: 18px;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: all .2s;
      line-height: 1;
      font-family: var(--mono);
    }

    .zoom-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(74,240,196,0.07);
    }

    /* ── BOTTOM BAR ────────────────────────────────────── */
    .bottom-bar {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      padding: 20px 32px;
      pointer-events: none;
      background: linear-gradient(to top, rgba(3,6,15,0.72) 0%, transparent 100%);
    }

    .stat-row { display: flex; flex-direction: column; gap: 5px; }

    .chip {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 9px;
      letter-spacing: 0.13em;
      text-transform: lowercase;
      color: var(--dim);
    }

    .chip-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }

    .legend { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
    .legend-label { font-size: 9px; letter-spacing: .18em; text-transform: lowercase; color: var(--dim); }
    .legend-bar { width: 140px; height: 4px; border-radius: 2px; background: linear-gradient(to right, #4af0c4, #ffd166, #ff6b6b); }
    .legend-ends { display: flex; justify-content: space-between; width: 140px; }
    .legend-end { font-size: 8.5px; letter-spacing: .1em; color: var(--dim); }

    /* ── LOADING ───────────────────────────────────────── */
    #loading {
      position: fixed;
      bottom: 72px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 15;
      font-size: 9px;
      letter-spacing: 0.28em;
      text-transform: lowercase;
      color: var(--dim);
      animation: breathe 1.4s ease-in-out infinite;
    }

    /* ── UPLOAD MODAL ──────────────────────────────────── */
    #modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 50;
      background: rgba(3,6,15,0.88);
      backdrop-filter: blur(12px);
      align-items: center;
      justify-content: center;
    }

    #modal.open { display: flex; }

    .modal-box {
      background: #05090f;
      border: 1px solid rgba(74,240,196,0.16);
      border-radius: 6px;
      padding: 40px;
      width: 490px;
      max-width: 92vw;
      position: relative;
      animation: pop .28s ease;
    }

    @keyframes pop {
      from { opacity: 0; transform: translateY(18px) scale(0.98); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .modal-x {
      position: absolute;
      top: 14px; right: 16px;
      background: none;
      border: none;
      color: var(--dim);
      font-size: 18px;
      cursor: pointer;
      transition: color .2s;
    }
    .modal-x:hover { color: var(--accent); }

    .modal-title {
      font-family: var(--display);
      font-size: 28px;
      letter-spacing: 0.08em;
      color: var(--accent);
      text-transform: lowercase;
      margin-bottom: 3px;
    }

    .modal-sub {
      font-size: 9px;
      letter-spacing: 0.14em;
      color: var(--dim);
      text-transform: lowercase;
      margin-bottom: 28px;
    }

    .dz {
      border: 1px dashed rgba(74,240,196,0.25);
      border-radius: 4px;
      padding: 36px 20px;
      text-align: center;
      cursor: pointer;
      transition: all .22s;
      margin-bottom: 20px;
    }

    .dz:hover, .dz.over {
      border-color: var(--accent);
      background: rgba(74,240,196,0.04);
    }

    .dz svg { width: 32px; height: 32px; fill: rgba(74,240,196,0.35); margin-bottom: 10px; }
    .dz-text { font-size: 11px; letter-spacing: .1em; color: var(--dim); }
    .dz-text span { color: var(--accent); }
    .dz-hint { font-size: 8.5px; letter-spacing: .12em; color: var(--dim); margin-top: 5px; }

    .opts { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; margin-bottom: 20px; }

    .opt {
      border: 1px solid rgba(74,240,196,0.11);
      border-radius: 4px;
      padding: 13px 15px;
      cursor: pointer;
      transition: all .2s;
    }

    .opt:hover, .opt.sel {
      border-color: rgba(74,240,196,0.42);
      background: rgba(74,240,196,0.05);
    }

    .opt-label { font-size: 8.5px; text-transform: lowercase; letter-spacing: .18em; color: var(--dim); margin-bottom: 3px; }
    .opt-val { font-family: var(--display); font-size: 15px; letter-spacing: .04em; color: var(--text); }

    .go-btn {
      width: 100%;
      padding: 14px;
      background: var(--accent);
      color: #03060f;
      border: none;
      border-radius: 2px;
      font-family: var(--display);
      font-size: 19px;
      letter-spacing: 0.18em;
      text-transform: lowercase;
      cursor: pointer;
      transition: all .22s;
    }

    .go-btn:hover {
      background: #7af8d8;
      box-shadow: 0 0 32px rgba(74,240,196,0.38);
    }

    #file-input { display: none; }
  </style>
</head>
<body>

<!-- 1 · starfield -->
<canvas id="starfield"></canvas>

<!-- 2 · ghost brand (behind globe) -->
<div id="brand-layer">
  <div class="brand-name">speechwrite</div>
  <div class="brand-slogan">speech right with speech write</div>
</div>

<!-- 3 · orbit decoration -->
<div class="orbit-ring">
  <svg class="orbit-svg" viewBox="0 0 400 400" fill="none">
    <circle cx="200" cy="200" r="197" stroke="rgba(74,240,196,0.055)" stroke-width="1"/>
    <circle cx="200" cy="200" r="197" stroke="url(#og)" stroke-width="1.2"
            stroke-dasharray="24 580"/>
    <circle cx="200" cy="3" r="3.5" fill="#4af0c4" opacity="0.75"/>
    <circle cx="200" cy="3" r="7"   fill="none" stroke="#4af0c4" stroke-width="0.6" opacity="0.3"/>
    <defs>
      <linearGradient id="og" x1="200" y1="0" x2="200" y2="400" gradientUnits="userSpaceOnUse">
        <stop offset="0%"   stop-color="#4af0c4" stop-opacity=".55"/>
        <stop offset="45%"  stop-color="#4af0c4" stop-opacity="0"/>
        <stop offset="100%" stop-color="#4af0c4" stop-opacity=".08"/>
      </linearGradient>
    </defs>
  </svg>
</div>

<!-- 4 · globe -->
<div id="globe-wrapper"><div id="globeViz"></div></div>

<!-- 5 · tooltip -->
<div id="tip">
  <div class="tip-inner">
    <div class="tip-country" id="tc">—</div>
    <div class="tip-accent"  id="ta">—</div>
    <div class="tip-wer"     id="tw">—</div>
    <div class="tip-wer-label">word error rate</div>
    <div class="tip-bar"><div class="tip-fill" id="tf"></div></div>
    <div class="tip-badge"   id="tb"></div>
  </div>
</div>

<!-- 6 · ui overlay -->
<div id="ui">
  <nav class="nav">
    <div class="logo-wrap">
      <div class="logo-name">speechwrite</div>
      <div class="logo-slogan">speech right with speech write</div>
    </div>
    <div class="nav-links">
      <a class="nav-link" href="research">research</a>
        <span class="nav-link">about</span>
      <button class="upload-btn" onclick="openModal()">
        <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
        upload audio
      </button>
    </div>
  </nav>

  <!-- zoom buttons -->
  <div class="zoom-controls">
    <button class="zoom-btn" id="zin"  title="zoom in">+</button>
    <button class="zoom-btn" id="zout" title="zoom out">−</button>
  </div>

  <div class="bottom-bar">
    <div class="stat-row">
      <div class="chip">
        <div class="chip-dot" style="background:var(--accent)"></div>
        52 accent regions · 96 countries mapped
      </div>
      <div class="chip">
        <div class="chip-dot" style="background:var(--accent3)"></div>
        drag to rotate · scroll or ± to zoom · hover to inspect
      </div>
    </div>
    <div class="legend">
      <div class="legend-label">word error rate</div>
      <div class="legend-bar"></div>
      <div class="legend-ends">
        <span class="legend-end">0% low</span>
        <span class="legend-end">high 60%</span>
      </div>
    </div>
  </div>
</div>

<!-- 7 · upload modal -->
<div id="modal">
  <div class="modal-box">
    <button class="modal-x" onclick="closeModal()">✕</button>
    <div class="modal-title">analyze audio</div>
    <div class="modal-sub">upload a recording — we compute wer against a reference transcript</div>

    <div class="dz" id="dz" onclick="document.getElementById('file-input').click()">
      <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
      <div class="dz-text">drop audio here or <span>browse</span></div>
      <div class="dz-hint">.mp3 · .wav · .m4a · .ogg · .flac</div>
    </div>
    <input type="file" id="file-input" accept="audio/*" onchange="onFile(event)" />

    <div class="opts">
      <div class="opt sel" data-g="model"><div class="opt-label">stt model</div><div class="opt-val">Whisper</div></div>
      <div class="opt"     data-g="model"><div class="opt-label">stt model</div><div class="opt-val">Google</div></div>
      <div class="opt sel" data-g="lang" ><div class="opt-label">language</div><div class="opt-val">English</div></div>
      <div class="opt"     data-g="lang" ><div class="opt-label">language</div><div class="opt-val">Auto-detect</div></div>
    </div>

    <button class="go-btn" onclick="analyze()">analyze speech →</button>
  </div>
</div>

<div id="loading">initializing globe…</div>

<!-- globe.gl (bundles Three.js) -->
<script src="https://unpkg.com/globe.gl@2.27.2/dist/globe.gl.min.js"></script>
<script>
/* ═══════════════════════════════════════
   STARFIELD
═══════════════════════════════════════ */
(function () {
  const cv = document.getElementById('starfield');
  const cx = cv.getContext('2d');
  let W, H, stars = [];

  function resize() { W = cv.width = innerWidth; H = cv.height = innerHeight; }

  function mkStar() {
    return {
      x: Math.random() * W, y: Math.random() * H,
      r: Math.random() * 1.25 + 0.1,
      o: Math.random() * 0.72 + 0.1,
      sp: Math.random() * 0.35 + 0.04,
      ph: Math.random() * Math.PI * 2,
      col: Math.random() > 0.96 ? '#4af0c4'
         : Math.random() > 0.93 ? '#ffd166' : '#ffffff'
    };
  }

  function init() { stars = Array.from({ length: Math.floor(W * H / 650) }, mkStar); }

  let t = 0;
  function draw() {
    cx.clearRect(0, 0, W, H);
    const g = cx.createRadialGradient(W/2,H/2,0, W/2,H/2, Math.hypot(W,H)*0.62);
    g.addColorStop(0, '#060f1e');
    g.addColorStop(0.5, '#040b16');
    g.addColorStop(1, '#03060f');
    cx.fillStyle = g; cx.fillRect(0, 0, W, H);
    t += 0.006;
    for (const s of stars) {
      cx.globalAlpha = s.o * (0.5 + 0.5 * Math.sin(t * s.sp + s.ph));
      cx.beginPath();
      cx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
      cx.fillStyle = s.col;
      cx.fill();
    }
    cx.globalAlpha = 1;
    requestAnimationFrame(draw);
  }

  resize(); init(); draw();
  addEventListener('resize', () => { resize(); init(); });
})();

/* ═══════════════════════════════════════
   WER DATA  (iso_a3 → { accent, wer })
═══════════════════════════════════════ */
const WER = {
  USA:{a:'General American',w:8.1},
  GBR:{a:'Received Pronunciation',w:12.3},
  AUS:{a:'Australian English',w:14.7},
  CAN:{a:'Canadian English',w:10.2},
  IND:{a:'Indian English',w:22.5},
  NGA:{a:'Nigerian English',w:41.7},
  ZAF:{a:'South African English',w:28.9},
  SGP:{a:'Singlish',w:31.2},
  IRL:{a:'Hiberno-English',w:16.4},
  NZL:{a:'New Zealand English',w:15.8},
  PAK:{a:'Pakistani English',w:27.3},
  PHL:{a:'Philippine English',w:20.1},
  JAM:{a:'Jamaican English',w:38.4},
  GHA:{a:'Ghanaian English',w:36.9},
  KEN:{a:'Kenyan English',w:33.2},
  ZWE:{a:'Zimbabwean English',w:30.5},
  TZA:{a:'Tanzanian English',w:34.1},
  CMR:{a:'Cameroonian English',w:39.7},
  BRA:{a:'Brazilian English',w:36.4},
  FRA:{a:'French-accented English',w:33.1},
  DEU:{a:'German-accented English',w:29.8},
  CHN:{a:'Chinese-accented English',w:35.6},
  JPN:{a:'Japanese-accented English',w:40.2},
  KOR:{a:'Korean-accented English',w:37.8},
  SAU:{a:'Arabic-accented English',w:44.3},
  RUS:{a:'Russian-accented English',w:31.7},
  POL:{a:'Polish-accented English',w:28.4},
  ESP:{a:'Spanish-accented English',w:32.1},
  ITA:{a:'Italian-accented English',w:30.9},
  PRT:{a:'Portuguese English',w:34.5},
  MEX:{a:'Mexican English',w:29.3},
  ARG:{a:'Argentine English',w:31.8},
  MYS:{a:'Malaysian English',w:25.4},
  IDN:{a:'Indonesian English',w:38.1},
  THA:{a:'Thai-accented English',w:43.2},
  VNM:{a:'Vietnamese English',w:41.9},
  EGY:{a:'Egyptian English',w:40.6},
  MAR:{a:'Moroccan English',w:42.8},
  ETH:{a:'Ethiopian English',w:44.1},
  TUR:{a:'Turkish English',w:35.3},
  IRN:{a:'Persian English',w:38.7},
  SWE:{a:'Swedish English',w:18.9},
  NOR:{a:'Norwegian English',w:17.6},
  DNK:{a:'Danish English',w:19.4},
  FIN:{a:'Finnish English',w:21.3},
  NLD:{a:'Dutch-accented English',w:16.8},
  BEL:{a:'Belgian English',w:22.7},
  CHE:{a:'Swiss English',w:23.5},
  AUT:{a:'Austrian English',w:26.1},
  GRC:{a:'Greek English',w:33.8},
  HUN:{a:'Hungarian English',w:29.6},
  CZE:{a:'Czech English',w:27.4},
  ROU:{a:'Romanian English',w:31.5},
};

function getW(iso) {
  if (WER[iso]) return WER[iso].w;
  let h = 0;
  for (const c of (iso||'')) h = (h*31 + c.charCodeAt(0)) & 0xffff;
  return 18 + (h % 36);
}
function getA(iso) { return WER[iso]?.a || 'English (regional)'; }

/* ═══════════════════════════════════════
   COLOR SCALE: teal → amber → coral
═══════════════════════════════════════ */
function wCol(w, al = 0.82) {
  const t = Math.min(w / 55, 1);
  let r, g, b;
  if (t < 0.4) {
    const u = t / 0.4;
    r = Math.round(74  + (255-74)  * u);
    g = Math.round(240 + (209-240) * u);
    b = Math.round(196 + (102-196) * u);
  } else {
    const u = (t - 0.4) / 0.6;
    r = 255;
    g = Math.round(209 * (1-u));
    b = Math.round(102 * (1-u));
  }
  return `rgba(${r},${g},${b},${al})`;
}

/* ═══════════════════════════════════════
   GLOBE
═══════════════════════════════════════ */
let globe;

function buildGlobe(geo) {
  // Normalize ISO field
  geo.features = geo.features.map(f => ({
    ...f,
    properties: {
      ...f.properties,
      iso: f.properties.iso_a3 || f.properties.ISO_A3 || '',
      name: f.properties.name || f.properties.ADMIN || f.properties.NAME || 'Unknown',
    }
  }));

  const features = geo.features.map(f => ({
    ...f,
    properties: {
      ...f.properties,
      wer: getW(f.properties.iso),
      accent: getA(f.properties.iso),
    }
  }));

  globe = Globe()
    .width(innerWidth)
    .height(innerHeight)
    .backgroundColor('rgba(0,0,0,0)')
    // Real Earth day texture from NASA/ESRI tiles
    .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
    .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
    .atmosphereColor('#4af0c4')
    .atmosphereAltitude(0.14)
    // Heatmap overlay polygons on top of the Earth texture
    .polygonsData(features)
    .polygonAltitude(d => {
      const w = d.properties.wer;
      return w > 40 ? 0.018 : w > 28 ? 0.01 : w > 16 ? 0.006 : 0.004;
    })
    .polygonCapColor(d => wCol(d.properties.wer, 0.62))
    .polygonSideColor(d => wCol(d.properties.wer, 0.22))
    .polygonStrokeColor(() => 'rgba(74,240,196,0.1)')
    .polygonLabel(null)
    .onPolygonHover(onHover)
    .polygonsTransitionDuration(350)
    (document.getElementById('globeViz'));

  // Transparent renderer so starfield shows
  globe.renderer().setClearColor(0x000000, 0);
  globe.renderer().domElement.style.position = 'absolute';

  // Controls
  const ctrl = globe.controls();
  ctrl.autoRotate = true;
  ctrl.autoRotateSpeed = 0.22;
  ctrl.enableZoom = true;         // ← zoom enabled
  ctrl.zoomSpeed = 0.9;
  ctrl.minDistance = 150;
  ctrl.maxDistance = 800;
  ctrl.minPolarAngle = 0.3;
  ctrl.maxPolarAngle = Math.PI - 0.3;

  // Pause auto-rotate while interacting
  const el = document.getElementById('globeViz');
  let timer;
  function pauseRotate() {
    ctrl.autoRotate = false;
    clearTimeout(timer);
    timer = setTimeout(() => ctrl.autoRotate = true, 2200);
  }
  el.addEventListener('mousedown', pauseRotate);
  el.addEventListener('wheel', pauseRotate, { passive: true });
  el.addEventListener('touchstart', pauseRotate, { passive: true });

  // Manual zoom buttons
  document.getElementById('zin').onclick  = () => { pauseRotate(); zoomBy(-60); };
  document.getElementById('zout').onclick = () => { pauseRotate(); zoomBy(+60); };

  addEventListener('resize', () => globe.width(innerWidth).height(innerHeight));
  document.getElementById('loading').style.display = 'none';
}

function zoomBy(delta) {
  if (!globe) return;
  const cam = globe.camera();
  const ctrl = globe.controls();
  // Move camera along its z axis
  const dir = cam.position.clone().normalize();
  cam.position.addScaledVector(dir, delta);
  ctrl.update();
}

/* ═══════════════════════════════════════
   HOVER TOOLTIP
═══════════════════════════════════════ */
const tip = document.getElementById('tip');

function onHover(poly) {
  if (!poly) { tip.style.display = 'none'; return; }
  const { name, wer, accent } = poly.properties;
  const col = wCol(wer, 1);
  const bias = wer < 20 ? { l:'low bias',  bg:'rgba(74,240,196,.13)', c:'#4af0c4' }
             : wer < 35 ? { l:'med bias',  bg:'rgba(255,209,102,.13)',c:'#ffd166' }
                        : { l:'high bias', bg:'rgba(255,107,107,.13)',c:'#ff6b6b' };

  document.getElementById('tc').textContent = name;
  document.getElementById('ta').textContent = accent;
  document.getElementById('tw').textContent = wer.toFixed(1) + '%';
  document.getElementById('tw').style.color = col;
  document.getElementById('tf').style.width = Math.min(wer/60*100,100) + '%';
  document.getElementById('tf').style.background = col;
  const badge = document.getElementById('tb');
  badge.textContent = bias.l;
  badge.style.background = bias.bg;
  badge.style.color = bias.c;
  tip.style.display = 'block';
}

document.addEventListener('mousemove', e => {
  if (tip.style.display !== 'block') return;
  const cw = tip.offsetWidth, ch = tip.offsetHeight;
  const x = e.clientX + 20, y = e.clientY - 12;
  tip.style.left = (x + cw > innerWidth  ? e.clientX - cw - 20 : x) + 'px';
  tip.style.top  = (y + ch > innerHeight ? e.clientY - ch - 12 : y) + 'px';
});

/* ═══════════════════════════════════════
   FETCH GEOJSON + BUILD
═══════════════════════════════════════ */
fetch('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson')
  .then(r => r.json())
  .then(buildGlobe)
  .catch(() => {
    document.getElementById('loading').textContent = 'failed to load map — check connection';
  });

/* ═══════════════════════════════════════
   MODAL
═══════════════════════════════════════ */
function openModal()  { document.getElementById('modal').classList.add('open'); }
function closeModal() { document.getElementById('modal').classList.remove('open'); }

document.getElementById('modal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeModal();
});

document.querySelectorAll('.opt').forEach(o => {
  o.addEventListener('click', function () {
    document.querySelectorAll(`.opt[data-g="${this.dataset.g}"]`)
            .forEach(c => c.classList.remove('sel'));
    this.classList.add('sel');
  });
});

function onFile(e) {
  const f = e.target?.files?.[0];
  if (!f) return;
  document.getElementById('dz').innerHTML = `
    <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
    <div class="dz-text"><span>${f.name}</span></div>
    <div class="dz-hint">${(f.size/1024).toFixed(1)} KB · ready to analyze</div>
  `;
}

const dz = document.getElementById('dz');
dz.addEventListener('dragover',  e => { e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('over'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('over');
  const f = e.dataTransfer.files[0];
  if (f?.type.startsWith('audio/')) onFile({ target: { files: [f] } });
});

function analyze() {
  closeModal();
  setTimeout(() => alert('Connect this to your STT backend:\nPOST audio → get transcript → compute WER → highlight region on globe.'), 200);
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
</script>
</body>
</html>